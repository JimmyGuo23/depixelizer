<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Depixelizer : Making sprites more awesome! (with hqNx and JavaScript)" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="hqx.js"></script>
	<script type="text/javascript" src="base64.js"></script>
	<script type="text/javascript" src="canvas2image.js"></script>
	
	<style type="text/css">
	/* Drag drop upload styles */
	#dropFiles
	{
		min-width: 100%;
		min-height: 100px;
		padding: 10px;
		border: 2px dotted #0090FF;
		-moz-border-radius: 15px;
		text-align: center;
		position: relative;
	}
	#dropFiles:before
	{
		content: "Drop Sprites Here!";
		color: #0090FF;
		font-size: 40px;
		font-weight: bold;
		opacity: 1;
		text-shadow: 2px 2px #AAA;
		position: absolute;
		width: 100%;
		left: 0;
		top: 50%;
		margin: -25px 0 0;
		z-index: 1;
		text-align: center;
	}
	</style>
		
    <title>Depixelizer</title>
	<script type="text/javascript">
		function OnFileChange(input)
		{
			if (input.files && input.files[0])
			{
				ProcessImages(input);
			}
			
			$('#selectFiles').replaceWith($('#selectFiles').clone()); 
		}
		
		$(function() {
			function upload(event) {
				var dt = event.dataTransfer,
					files = dt.files,
					count = files.length;
				
				event.stopPropagation();
				event.preventDefault();
				
				ProcessImages(dt);
			}
			
			var dropContainer = $('#dropFiles').get(0);
			dropContainer.addEventListener("dragenter", function(event){event.stopPropagation();event.preventDefault();}, false);
			dropContainer.addEventListener("dragover", function(event){event.stopPropagation();event.preventDefault();}, false);
			dropContainer.addEventListener('drop', upload, false);
		});
		
		function ProcessImages(dataTransfer)
		{
			$("#output").empty();
			
			for (var fileIndex = 0; fileIndex < dataTransfer.files.length; fileIndex++)
			{
				var reader = new FileReader();

				reader.onload = function (e)
				{
					var $img = $("<img />");
					var img = $img[0];
					$("#output").append($img);
					
					img.onload = function() {
						$img.before("<h2>Original (" + img.naturalWidth + " x " + img.naturalHeight + ")</h2>");
						
						$img.width(img.naturalWidth);
						//$img.height(img.naturalHeight);
					
						var png = convertCanvas("PNG", hqx(img, 4));
						if (png) {
							$(png).width(img.naturalWidth * 4);
							//$(png).height(img.naturalHeight * 4);
							
							$img.after( png );
							$img.after("<h2>Depixelized (" + (img.naturalWidth * 4) + " x " + (img.naturalHeight * 4) + ")</h2>");
						}
					};
					
					$img.attr('src', e.target.result);
				}
				
				reader.readAsDataURL(dataTransfer.files[fileIndex]);
			}
		}
		
		function convertCanvas(strType, oCanvas) {
			var oImg;
			if (strType == "PNG")
				oImg = Canvas2Image.saveAsPNG(oCanvas, true);
			else if (strType == "BMP")
				oImg = Canvas2Image.saveAsBMP(oCanvas, true);
			else if (strType == "JPEG")
				oImg = Canvas2Image.saveAsJPEG(oCanvas, true);

			if (!oImg) {
				alert("Sorry, this browser is not capable of saving " + strType + " files!");
				return undefined;
			}
			
			return oImg;
		}
	</script>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/nickdarnell/depixelizer">View on GitHub</a>

          <h1 id="project_title">Depixelizer</h1>
          <h2 id="project_tagline">Making sprites more awesome! (with hqNx)</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
		<p>
			<form method="post" enctype="multipart/form-data" style="text-align: center;">
				<input id="selectFiles" type="file" multiple="" onchange="OnFileChange(this);" />
				<h3>or</h3>
				<div id="dropFiles"></div>
			</form>
			<div id="output"></div>
		</p>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Depixelizer maintained by <a href="http://www.nickdarnell.com/">Nick Darnell</a>.</p>
        <p>hqNx implementation by <a href="https://github.com/phoboslab/js-hqx">PhobosLab</a></p>
      </footer>
    </div>

  </body>
</html>
